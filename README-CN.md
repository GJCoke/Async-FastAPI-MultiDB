<div align="center">
  <img src="./docs/images/logo.svg" width="160" alt="FastAPI">
  <h1>Async-FastAPI-MultiDB</h1>
  <span><a href="./README.md">English</a> | ä¸­æ–‡</span>
</div>

è¿™æ˜¯ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å¼‚æ­¥ FastAPI é¡¹ç›®æ¨¡æ¿ï¼Œé›†æˆäº† FastAPI + Celery + JWT + RBAC + MinIO ç­‰æ ¸å¿ƒæ¨¡å—ï¼Œæ”¯æŒ MongoDB ä¸ PostgreSQL çš„åŒæ•°æ®åº“æ¶æ„ï¼Œå…·å¤‡é«˜æ€§èƒ½ã€æ˜“æ‰©å±•ã€æ˜“ç»´æŠ¤çš„ç‰¹ç‚¹ï¼Œé€‚åˆç”¨äºä¸­å¤§å‹åç«¯é¡¹ç›®å¼€å‘ã€‚

---

## ç›®å½•æ€»è§ˆ

- [é¡¹ç›®ç‰¹ç‚¹](#é¡¹ç›®ç‰¹ç‚¹)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é¡¹ç›®æ¶æ„æ¦‚è§ˆ](#Async-FastAPI-MultiDB-é¡¹ç›®æ¶æ„æ¦‚è§ˆ)
- [é¡¹ç›®ç»“æ„](#ç›®å½•ç»“æ„è¯´æ˜)
- [ Celery å¼‚æ­¥ä»»åŠ¡å¢å¼º](#Celery)
- [èº«ä»½è®¤è¯ä¸æƒé™ç³»ç»Ÿ](#Auth-æ¨¡å—è¯´æ˜)
- [æµ‹è¯•è¯´æ˜](#è¿è¡Œæµ‹è¯•ä½¿ç”¨-Pytest)
- [License](#è®¸å¯è¯)

## é¡¹ç›®ç‰¹ç‚¹
### å¼‚æ­¥æ¶æ„
- å…¨é¢æ”¯æŒ `async/await` å¼‚æ­¥å¤„ç†ï¼Œæå‡å¹¶å‘æ€§èƒ½ï¼Œé€‚åˆé«˜è´Ÿè½½ API æœåŠ¡ã€‚

### SQL & NoSQL åŒæ•°æ®åº“é›†æˆ
- åŒæ—¶æ”¯æŒï¼š
  - **SQLModel / SQLAlchemy**ï¼šæ”¯æŒ MySQLã€PostgreSQL ç­‰å…³ç³»å‹æ•°æ®åº“ã€‚
  - **Beanie**ï¼šMongoDB çš„å¼‚æ­¥ ODMï¼Œé€‚åˆæ–‡æ¡£æ•°æ®åº“åœºæ™¯ã€‚
- çµæ´»ç»„åˆä½¿ç”¨ï¼Œæ»¡è¶³å¤æ‚ä¸šåŠ¡å¯¹å¤šç§æ•°æ®æ¨¡å‹çš„éœ€æ±‚ã€‚

### æ¨¡å—åŒ–è®¾è®¡
- è·¯ç”±ã€æ¨¡å‹ã€æœåŠ¡ã€æ•°æ®åº“æ“ä½œç­‰é«˜å†…èšä½è€¦åˆï¼Œé¡¹ç›®ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤ä¸æ‰©å±•ã€‚
- é€‚ç”¨äºå¤§å‹é¡¹ç›®å¼€å‘åŠå¤šäººåä½œã€‚

### è‡ªåŠ¨ API æ–‡æ¡£
- åˆ©ç”¨ FastAPI çš„å†…ç½®ç‰¹æ€§ï¼Œè‡ªåŠ¨ç”Ÿæˆäº¤äº’å¼ API æ–‡æ¡£ï¼ˆæ”¯æŒ Swagger å’Œ Redocï¼‰ã€‚

### ç¯å¢ƒé…ç½®ç®¡ç†
- æ”¯æŒåŸºäº `.env` æ–‡ä»¶çš„å¤šç¯å¢ƒåˆ‡æ¢ã€‚
- ä½¿ç”¨ `pydantic-settings` ç®¡ç†é…ç½®ï¼Œå®‰å…¨ã€çµæ´»ã€æ˜“æ‰©å±•ã€‚

### å¯¹è±¡å­˜å‚¨ MinIO å°è£…
- é›†æˆ MinIOï¼Œå…¼å®¹ Amazon S3 åè®®ï¼Œå¯æ— ç¼å¯¹æ¥é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ã€‚
- å°è£…å¸¸ç”¨åŠŸèƒ½ï¼Œå¼€ç®±å³ç”¨ï¼š
  - è·å–é¢„ç­¾åä¸Šä¼ é“¾æ¥
  - åˆ†å—ä¸Šä¼ æ”¯æŒ
  - æ–‡ä»¶ä¸‹è½½åœ°å€ç”Ÿæˆ
  - å­˜å‚¨æ¡¶ä¿¡æ¯ç®¡ç†
- æ¨èä½¿ç”¨å®˜æ–¹ Python SDKï¼Œæ›¿ä»£ boto3ï¼Œæ€§èƒ½æ›´ä¼˜ï¼ŒAPI æ›´ç®€æ´ã€‚
- å®ç°ç»†èŠ‚å¯å‚è€ƒï¼š`src/utils/minio_client.py`

### Celery å¼‚æ­¥ä»»åŠ¡å¢å¼ºï¼ˆ[è¯¦æƒ…](#Celery)ï¼‰
- ç±»ä¼¼ `django-celery-beat` çš„åŠ¨æ€ä»»åŠ¡è°ƒåº¦ï¼ˆä½†ä¸æ¡†æ¶æ— å…³ï¼‰
- åŸç”Ÿæ”¯æŒ `async def` å¼‚æ­¥ä»»åŠ¡ï¼Œè‡ªåŠ¨é€‚é…ã€‚
- æ›´åŠ å‹å¥½çš„ç±»å‹æç¤ºå’Œ IDE ä½“éªŒã€‚

### è®¤è¯ä¸æƒé™ç³»ç»Ÿï¼ˆ[è¯¦æƒ…](#Auth-æ¨¡å—è¯´æ˜)ï¼‰
- **èº«ä»½éªŒè¯**ï¼š
  - æ”¯æŒ Access Token + Refresh Token åŒ token æ¨¡å¼
  - ç™»å½•å¯†ç é€šè¿‡ **RSA åŠ å¯†** æäº¤ï¼Œä¿éšœä¼ è¾“å®‰å…¨
- **æƒé™æ§åˆ¶**ï¼š
  - åŸºäºè·¯ç”±çš„ **è§’è‰²ï¼ˆRBACï¼‰ æƒé™æ¨¡å‹**
  - æƒé™ç¼“å­˜åŸºäº Redisï¼Œå®ç°é«˜æ€§èƒ½æ ¡éªŒ
- **å¼€å‘ä½“éªŒ**ï¼š
  - ä½¿ç”¨ FastAPI çš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿè¿›è¡Œæƒé™æ³¨å…¥ï¼Œç±»å‹æ³¨è§£æ˜ç¡®ï¼Œæ–¹ä¾¿æ‰©å±•

> ğŸš§ æœ¬é¡¹ç›®æŒç»­å¼€å‘ä¸­ï¼Œæ¬¢è¿å…³æ³¨ã€Star æˆ–æå‡º Issue ä¸ PRã€‚

---

## Async-FastAPI-MultiDB é¡¹ç›®æ¶æ„æ¦‚è§ˆ
<div align="center">
  <img src="./docs/images/architecture-cn.svg" alt="FastAPI">
</div>

æœ¬æ–‡æ¡£æä¾›äº†ä¸€ä¸ª FastAPI é¡¹ç›®çš„åŸºæœ¬æ¶æ„æ¦‚è§ˆï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…ç†è§£é¡¹ç›®çš„ç»„ç»‡ç»“æ„åŠå„ä¸ªæ¨¡å—çš„åŠŸèƒ½ã€‚é€šè¿‡å¯¹é¡¹ç›®ç›®å½•çš„è¯¦ç»†è§£æï¼Œè¯»è€…å¯ä»¥å¿«é€ŸæŒæ¡å¦‚ä½•æ„å»ºå’Œç»´æŠ¤ä¸€ä¸ªé«˜æ•ˆçš„ FastAPI åº”ç”¨ã€‚

## ç›®å½•ç»“æ„è¯´æ˜
```
src/
â”‚
â”œâ”€â”€ api/                  # æ¥å£è·¯ç”±å®šä¹‰å±‚ï¼ŒæŒ‰ç‰ˆæœ¬ç»„ç»‡
â”‚   â”œâ”€â”€ v1/               # v1 ç‰ˆæœ¬æ¥å£
â”‚   â”‚   â”œâ”€â”€ auth.py       # ç™»å½•ã€æ³¨å†Œã€æƒé™ç›¸å…³æ¥å£
â”‚   â”‚   â””â”€â”€ router.py     # v1 è·¯ç”±æ±‡æ€»
â”‚   â””â”€â”€ v2/               # v2 ç‰ˆæœ¬é¢„ç•™æˆ–å¼€å‘ä¸­
â”‚       â””â”€â”€ __init__.py
â”‚
â”œâ”€â”€ core/                 # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ config.py         # è¯»å–ç¯å¢ƒå˜é‡ã€Settings ç®¡ç†
â”‚   â”œâ”€â”€ database.py       # æ•°æ®åº“è¿æ¥ï¼ˆSQLModelã€Mongo ç­‰ï¼‰
â”‚   â”œâ”€â”€ environment.py    # è¿è¡Œç¯å¢ƒæ£€æµ‹ï¼ˆå¦‚æ˜¯å¦ dev/test/prodï¼‰
â”‚   â”œâ”€â”€ exceptions.py     # è‡ªå®šä¹‰å¼‚å¸¸ç±»
â”‚   â”œâ”€â”€ lifecycle.py      # FastAPI åº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
â”‚   â””â”€â”€ route.py          # åŠ¨æ€è·¯ç”±æ³¨å†Œæ”¯æŒ
â”‚
â”œâ”€â”€ crud/                 # ç›´æ¥é¢å‘æ•°æ®åº“çš„ CRUD æ“ä½œ
â”‚   â””â”€â”€ router.py         # ç¤ºä¾‹æˆ–é€šç”¨æ•°æ®åº“æ“ä½œ
â”‚
â”œâ”€â”€ deps/                 # FastAPI ä¾èµ–é¡¹ï¼ˆDepends ä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ auth.py           # æƒé™/è§’è‰²ä¾èµ–æ ¡éªŒ
â”‚   â”œâ”€â”€ database.py       # DB è¿æ¥ä¾èµ–
â”‚   â”œâ”€â”€ environment.py    # ç¯å¢ƒç›¸å…³ä¾èµ–
â”‚   â”œâ”€â”€ role.py           # è§’è‰²æƒé™æ³¨å…¥
â”‚   â””â”€â”€ router.py         # è·¯ç”±çº§ä¾èµ–
â”‚
â”œâ”€â”€ middlewares/          # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ logger.py         # æ—¥å¿—è®°å½•
â”‚
â”œâ”€â”€ models/               # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ auth.py           # ç”¨æˆ·ã€æƒé™ç­‰è¡¨ç»“æ„
â”‚   â”œâ”€â”€ base.py           # é€šç”¨åŸºç±»ï¼Œå¦‚æ—¶é—´æˆ³ã€ID ç­‰
â”‚   â””â”€â”€ router.py         # è·¯ç”±æ¨¡å‹å®šä¹‰ï¼ˆå¦‚æƒé™è·¯ç”±è¡¨ï¼‰
â”‚
â”œâ”€â”€ queues/               # Celery å¼‚æ­¥ä»»åŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ tasks/            # ä»»åŠ¡å®šä¹‰
â”‚   â”‚   â””â”€â”€ tasks.py      # ç¤ºä¾‹å¼‚æ­¥ä»»åŠ¡é›†åˆ
â”‚   â”œâ”€â”€ app.py            # Celery å®ä¾‹åˆ›å»º
â”‚   â”œâ”€â”€ celery.py         # Celery å¯åŠ¨å…¥å£
â”‚   â”œâ”€â”€ models.py         # ä¸å¼‚æ­¥ä»»åŠ¡ç›¸å…³çš„æ¨¡å‹ï¼ˆå¦‚ä»»åŠ¡è®°å½•è¡¨ï¼‰
â”‚   â”œâ”€â”€ scheduler.py      # å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
â”‚   â””â”€â”€ task.py           # ä»»åŠ¡æ³¨å†Œã€å°è£…
â”‚
â”œâ”€â”€ schemas/              # è¯·æ±‚/å“åº”æ•°æ®ç»“æ„å®šä¹‰
â”‚   â”œâ”€â”€ auth.py           # ç”¨æˆ·ç™»å½•ã€æ³¨å†Œç­‰æ¨¡å‹
â”‚   â”œâ”€â”€ base.py           # é€šç”¨å­—æ®µæ¨¡å‹
â”‚   â”œâ”€â”€ request.py        # è¯·æ±‚ç»“æ„ä½“
â”‚   â”œâ”€â”€ response.py       # å“åº”ç»“æ„ä½“ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ role.py           # è§’è‰²ç›¸å…³ schema
â”‚   â””â”€â”€ router.py         # è·¯ç”±/æ¥å£ç›¸å…³ schema
â”‚
â”œâ”€â”€ services/             # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â””â”€â”€ auth.py           # ç”¨æˆ·è®¤è¯æœåŠ¡ï¼ˆç™»å½•æ ¡éªŒã€å‘ token ç­‰ï¼‰
â”‚
â”œâ”€â”€ utils/                # å·¥å…·æ–¹æ³•é›†åˆ
â”‚   â”œâ”€â”€ constants.py      # å…¨å±€å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ date.py           # æ—¶é—´å¤„ç†å‡½æ•°
â”‚   â”œâ”€â”€ minio_client.py   # MinIO å¯¹è±¡å­˜å‚¨å°è£…
â”‚   â”œâ”€â”€ security.py       # åŠ å¯†ã€JWT å·¥å…·
â”‚   â”œâ”€â”€ uuid7.py          # è‡ªå®šä¹‰ UUID å·¥å…·
â”‚   â””â”€â”€ validate.py       # å­—æ®µã€è¡¨å•éªŒè¯å·¥å…·
â”‚
â”œâ”€â”€ websockets/           # WebSocket è·¯ç”±å’Œé€»è¾‘
â”‚   â”œâ”€â”€ __init__.py
â”‚
â”œâ”€â”€ initdb.py             # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼ˆå¦‚å»ºè¡¨ã€æ’å…¥é»˜è®¤æ•°æ®ï¼‰
â”œâ”€â”€ main.py               # FastAPI åº”ç”¨ä¸»å…¥å£
```

---

## å¿«é€Ÿå¼€å§‹
1. å…‹éš†ä»“åº“ï¼š
    ```bash
    git clone https://github.com/GJCoke/Async-FastAPI-MultiDB.git
    cd Async-FastAPI-MultiDB
    ```

2. å¤åˆ¶ç¯å¢ƒå˜é‡ä¿¡æ¯ï¼š
    ```bash
    cp .env.example .env
    ```

3. è¿è¡ŒDocker
    ```bash
    docker network create app_network
    docker compose up -d --build
    ```

4. è¿è¡Œ Alembic åˆ›å»ºæ•°æ®åº“ç»“æ„
    ```bash
    docker compose exec app scripts/alembic-makemigrations.sh "Init Database"
    docker compose exec app scripts/alembic-migrate.sh
    ```

5. è¿è¡Œ initdb è„šæœ¬ç”Ÿæˆåˆå§‹æ•°æ®
    ```bash
    docker compose exec app scripts/initdb.sh
    ```

6. é»˜è®¤ç”¨æˆ·åå¯†ç 

    åˆå§‹åŒ–åå°†ç”Ÿæˆä¸€ä¸ªé»˜è®¤ç”¨æˆ·ï¼Œé»˜è®¤è´¦å·ä¿¡æ¯å¦‚ä¸‹ï¼š
    - **ç”¨æˆ·å**ï¼š`admin`
    - **å¯†ç **ï¼š`123456`

    > å¯ç”¨äºè®¿é—®ç³»ç»Ÿæˆ–ç”¨äºè°ƒè¯•èº«ä»½éªŒè¯ç›¸å…³æ¥å£ã€‚
    >
    > âš ï¸è¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŠæ—¶ä¿®æ”¹é»˜è®¤å¯†ç ï¼

7. å¼€å‘
   æœ¬é¡¹ç›®ä½¿ç”¨ `pre-commit` æ¥ç¡®ä¿ä»£ç åœ¨æäº¤å‰çš„è´¨é‡å’Œä¸€è‡´æ€§ã€‚å®ƒä¼šåœ¨ä»£ç æäº¤å‰è‡ªåŠ¨è¿è¡Œæ£€æŸ¥å·¥å…·å’Œæ ¼å¼åŒ–å·¥å…·ã€‚
    ```bash
    pre-commit install
    ```

   > `pre-commit` çš„é…ç½®æ–‡ä»¶æ˜¯ `.pre-commit-config.yaml`ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹é’©å­ï¼š
   > - å¤§æ–‡ä»¶æ£€æŸ¥ï¼šæäº¤çš„ä»£ç ä¸­æ˜¯å¦æ·»åŠ äº†è¿‡å¤§çš„æ–‡ä»¶ã€‚
   > - ä»£ç æ ¼å¼åŒ–ï¼šä½¿ç”¨ ruff è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ã€‚
   > - é™æ€ä»£ç æ£€æŸ¥ï¼šä½¿ç”¨ mypy è¿›è¡Œé™æ€ä»£ç æ£€æŸ¥ã€‚

> è®¿é—® [http://localhost:16000/docs](http://localhost:16000/docs) å³å¯æŸ¥çœ‹ Swagger æ–‡æ¡£

#### ç¤ºä¾‹1
![swagger-1](docs/images/swagger-1.png)
#### ç¤ºä¾‹2
> é”™è¯¯å“åº”å·²ç»Ÿä¸€å¢å¼ºå¤„ç†ï¼Œæ— éœ€åœ¨æ¯ä¸ªè·¯ç”±ä¸­å•ç‹¬æ·»åŠ é”™è¯¯å“åº”ã€‚

![swagger-2](docs/images/swagger-2.png)

---

## è¿è¡Œæµ‹è¯•ï¼ˆä½¿ç”¨ Pytestï¼‰
åœ¨è¿è¡Œæµ‹è¯•å‰ï¼Œè¯·ç¡®ä¿ä½ å®Œæˆäº†ä»¥ä¸‹å‡†å¤‡å·¥ä½œï¼š

1. å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®ï¼š
    ```bash
    cp .env.pytest.example .env.pytest
    ```

2. é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯

   > ä½ å¯ä»¥æ‰‹åŠ¨é…ç½® .env.pytest ä¸­çš„æ•°æ®åº“è¿æ¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¯åŠ¨é¢„é…ç½®çš„æµ‹è¯•æ•°æ®åº“ Dockerï¼š

   **é€‰é¡¹Aï¼šä½¿ç”¨ Docker å¯åŠ¨æµ‹è¯•æ•°æ®åº“**
   ```bash
    docker compose -f docker-compose-pytest.yml up -d --build
   ```
   **é€‰é¡¹ Bï¼šæ‰‹åŠ¨é…ç½® .env.pytest**
   ```dotenv
    # MongoDBï¼ˆå¿…å¡«ï¼‰
    MONGO_DATABASE_URL=mongodb://localhost:27017

    # Redisï¼ˆå¿…å¡«ï¼‰
    REDIS_DATABASE_URL=redis://localhost:6379

    # SQLiteï¼ˆé»˜è®¤å…³ç³»å‹æ•°æ®åº“ï¼‰
    SQL_DATABASE_URL=sqlite+aiosqlite://
   ```

3. è¿è¡Œæµ‹è¯•
   ```bash
   pytest -s
   ```

4. è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
   ```bash
   # è¿è¡Œæµ‹è¯•å¹¶æ”¶é›†è¦†ç›–ç‡æ•°æ®
   coverage run -m --source=src pytest -s tests/

   # æŸ¥çœ‹ç®€è¦è¦†ç›–ç‡æŠ¥å‘Š
   coverage report

   # ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ htmlcov/index.html æ–‡ä»¶
   coverage html

   # æ¸…é™¤å†å²æ•°æ®
   coverage erase
   ```

---

## Auth æ¨¡å—è¯´æ˜
æœ¬æ¨¡å—ç”¨äºå¤„ç†è®¤è¯æˆæƒã€é‰´æƒç›¸å…³åŠŸèƒ½ï¼ŒåŸºäº JWT + Redis + RSA + RBAC å®ç°ã€‚
<div align="center">
  <img src="./docs/images/rbac-cn.svg" alt="FastAPI">
</div>

### åŠŸèƒ½æ¦‚è¿°
- ç”¨æˆ·ç™»å½•ï¼ˆç”¨æˆ·åå¯†ç ï¼‰
- AccessToken / RefreshToken ç”Ÿæˆä¸æ ¡éªŒ
- Token åˆ·æ–°
- Token ç™»å‡º
- ç”¨æˆ·ä¿¡æ¯æ³¨å…¥ä¾èµ–å°è£…
- ç¯å¢ƒé™åˆ¶ä¾èµ–ï¼ˆDebugï¼‰
- RBAC è®¿é—®æ§åˆ¶æ¨¡å‹

### å¯†ç åŠ å¯†ï¼ˆRSAï¼‰
> æ— éœ€æ‹…å¿ƒæ·»åŠ  RSA å Swagger æ–‡æ¡£æ— æ³•ä½¿ç”¨ï¼Œå› ä¸º Swagger æ–‡æ¡£æœ‰ç‹¬ç«‹çš„ç™»å½•é€»è¾‘ï¼Œå¹¶ä¸”è¯¥é€»è¾‘ä»…åœ¨ DEBUG ç¯å¢ƒä¸‹ç”Ÿæ•ˆã€‚

ç™»å½•æ—¶å‰ç«¯ä½¿ç”¨åç«¯æä¾›çš„ RSA å…¬é’¥åŠ å¯†å¯†ç ï¼Œåç«¯ä½¿ç”¨ç§é’¥è§£å¯†ã€‚ä¿è¯å¯†ç ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¼šæ˜æ–‡æš´éœ²ã€‚

> å¯†é’¥å¯¹å»ºè®®ç”±ç¯å¢ƒé…ç½®æä¾›ã€‚
>
> å½“å‰ `DEBUG` ç¯å¢ƒæ”¯æŒåŠ¨æ€ç”Ÿæˆ, ä½†æ˜¯ä¸æ¨èåœ¨éƒ¨ç½²ç¯å¢ƒä¸­ä½¿ç”¨ã€‚
>
> åœ¨å¤šä¸ªæœåŠ¡æˆ–å®ä¾‹ä¸­ä½¿ç”¨åŠ¨æ€ç”Ÿæˆä¼šå¯¼è‡´ä¸ä¸€è‡´çš„è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯åœ¨è´Ÿè½½å‡è¡¡æˆ–åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰ç­‰æƒ…å†µä¸‹ã€‚

### Token è¯´æ˜
- **AccessToken:** çŸ­æ•ˆï¼Œå­˜åœ¨å®¢æˆ·ç«¯ï¼Œç”¨äºæ¥å£é‰´æƒ
- **RefreshToken:** é•¿æ•ˆï¼Œå­˜åœ¨ Redisï¼Œæ”¯æŒåˆ·æ–°æ“ä½œ

> RefreshToken å†…åµŒ `jti`ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ä¸ `User-Agent`ï¼Œç¡®ä¿æ¯æ¬¡åˆ·æ–°æ¥æºä¸€è‡´ã€‚

### RBAC
- æ— éœ€ä¸ºæ¯ä¸ªæ¥å£æ‰‹åŠ¨å®šä¹‰æƒé™ä»£ç ï¼Œç³»ç»Ÿå¯æ ¹æ®æ¥å£è·¯å¾„ä¸è¯·æ±‚æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆå¹¶åŒ¹é…æƒé™æ ‡è¯†ï¼Œå®ç°è‡ªåŠ¨åŒ–æƒé™ç®¡ç†ã€‚
- ç”¨æˆ·æƒé™ä¿¡æ¯ä»¥ç»“æ„åŒ–æ•°æ®å­˜å‚¨äº Redis ä¸­ï¼Œç»“åˆè®¿é—®ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸè¿›è¡Œç¼“å­˜ï¼Œæœ‰æ•ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼Œå¤§å¹…æå‡æƒé™æ ¡éªŒæ•ˆç‡ä¸ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚

### æ ¸å¿ƒä¾èµ–

| åç§°                      | è¯´æ˜                             |
|-------------------------|--------------------------------|
| `HeaderAccessTokenDep`  | è·å– Header ä¸­çš„ AccessToken       |
| `HeaderRefreshTokenDep` | è·å– Header ä¸­çš„ RefreshToken      |
| `HeaderUserAgentDep`    | è·å– Header ä¸­çš„ User-Agent        |
| `UserAccessJWTDep`      | è§£ç  AccessToken åçš„ç”¨æˆ·ä¿¡æ¯          |
| `UserRefreshJWTDep`     | è§£ç  RefreshToken å¹¶æ ¡éªŒ User-Agent |
| `AuthCrudDep`           | æ•°æ®åº“æ“ä½œå°è£…ï¼Œç”¨äºè·å–ç”¨æˆ·ä¿¡æ¯               |
| `UserRefreshDep`        | ä» Redis + DB æ ¡éªŒå¹¶è·å–ç”¨æˆ·ä¿¡æ¯         |
| `UserDBDep`             | ä» DB è·å–ç”¨æˆ·ä¿¡æ¯                    |
| `VerifyPermissionDep`   | åŸºäºè·¯ç”±æ ¡éªŒç”¨æˆ·è®¿é—®æƒé™                   |

### è·¯ç”±ç®€è¿°
- `GET /keys/public`ï¼šè·å–ç”¨äºåŠ å¯†å¯†ç çš„RSAå…¬é’¥
- `POST /login`ï¼šç”¨æˆ·ç™»å½•ï¼Œè¿”å› access_token å’Œ refresh_token
- `POST /token/refresh`ï¼šåˆ·æ–° tokenï¼Œéœ€æºå¸¦ refresh_token å’Œ User-Agent
- `POST /logout`ï¼šç™»å‡ºï¼Œåˆ é™¤ Redis ä¸­çš„ refresh_token
- `GET /user/info`ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
- `GET /router/backend`ï¼šè·å–åº”ç”¨è·¯ç”±

### Redis ç»“æ„
- å­˜å‚¨ Keyï¼š `auth:refresh:<{user_id}>:<{jti}>`
- å­˜å‚¨ Valueï¼šRefreshTokenï¼ˆå« `created_at`, `refresh_token`, `user-agent` ç­‰ï¼‰
- å­˜å‚¨ Keyï¼š `auth:permission:<{user_id}>`
- å­˜å‚¨ Valueï¼šå½“å‰ç”¨æˆ·çš„æƒé™ Code

> å¯æ‰©å±•å¦‚ï¼šæ·»åŠ  IP åœ°å€æ ¡éªŒã€æ·»åŠ è®¾å¤‡ ID / å¹³å°æ ‡è¯†ã€é™åˆ¶åˆ·æ–°æ¥æºã€æ§åˆ¶å¤šç«¯ç™»å½•ç­–ç•¥

> æ‰€æœ‰ä¾èµ–å’Œé€»è¾‘å‡é€šè¿‡ç±»å‹æ³¨è§£ä¸ FastAPI è‡ªåŠ¨æ³¨å…¥å®ç°ï¼Œä¾¿äºå¤ç”¨ä¸æ‰©å±•ã€‚

---

## Celery

### DatabaseScheduler â€” æ•°æ®åº“åŠ¨æ€è°ƒåº¦å™¨
é€šè¿‡è‡ªå®šä¹‰è°ƒåº¦å™¨ `DatabaseScheduler`ï¼Œå®ç°ä»æ•°æ®åº“ä¸­åŠ¨æ€åŠ è½½å‘¨æœŸä»»åŠ¡ï¼Œå¹¶æ”¯æŒå®šæ—¶è‡ªåŠ¨åˆ·æ–°ï¼š

- ç±»ä¼¼ `django-celery-beat`ï¼Œä½†å¯è‡ªç”±é›†æˆäºä»»æ„ Web æ¡†æ¶ï¼ˆFastAPIï¼‰
- å‘¨æœŸæ€§åœ°ï¼ˆå¦‚æ¯ 60 ç§’ï¼‰ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡ï¼Œæ— éœ€é‡å¯ Worker
- è‡ªåŠ¨åˆå¹¶é…ç½®æ–‡ä»¶ä¸­çš„ä»»åŠ¡ï¼Œä¼˜å…ˆä½¿ç”¨é…ç½®é¡¹
- æ”¯æŒ `AsyncSession` `asyncpg` ä½ æ— éœ€å†å‘ä¹‹å‰ä¸€æ ·æä¾›ä¸€ä¸ªåŒæ­¥çš„æ•°æ®åº“

#### ç¤ºä¾‹ä»£ç 
```python
from src.core.config import settings
from src.queues.celery import Celery

REDIS_URL = str(settings.CELERY_REDIS_URL)
DATABASE_URL = "postgresql+asyncpg://your_username:your_password@localhost:27017/you_database"
app = Celery("celery_app", broker=REDIS_URL, backend=REDIS_URL)
app.conf.update({"timezone": settings.CELERY_TIMEZONE, "database_url": DATABASE_URL, "refresh_interval": 60})

app.autodiscover_tasks(["src.queues.tasks"])
```

è¿è¡Œ Celery beat `celery -A "src.queues.app" beat -S "src.queues.scheduler:AsyncDatabaseScheduler" -l info`

### AsyncTask â€” åŸç”Ÿæ”¯æŒ async def
é€šè¿‡è‡ªå®šä¹‰ Task åŸºç±»ï¼Œè®© Celery æ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„è‡ªåŠ¨è¯†åˆ«ä¸æ‰§è¡Œï¼š

- å¦‚æœä»»åŠ¡æ˜¯ async defï¼Œè‡ªåŠ¨ä½¿ç”¨ asyncio.run() æˆ–å½“å‰äº‹ä»¶å¾ªç¯è¿è¡Œ
- æ— éœ€æ‰‹åŠ¨åŒºåˆ† sync / asyncï¼Œç»Ÿä¸€ä»»åŠ¡è°ƒç”¨é€»è¾‘
- å®Œå…¨å…¼å®¹å·²æœ‰çš„åŒæ­¥ä»»åŠ¡

#### ç¤ºä¾‹ä»£ç 
```python
import asyncio

from src.queues.app import app


@app.task
async def run_async_task() -> None:
    print("async task start.")
    await asyncio.sleep(10)
    print("async task done.")
```

è¿è¡Œ Celery worker `celery -A "src.queues.app" worker -l info`

### TypedCelery â€” å¢å¼ºç±»å‹æç¤ºçš„ Celery å°è£…
å¯¹åŸç”Ÿ Celery è¿›è¡Œäº†å°è£…ï¼Œä»¥è·å¾—æ›´ç²¾å‡†çš„ç±»å‹æç¤ºæ”¯æŒï¼š

- é‡å†™äº† Celery éƒ¨åˆ†å‡½æ•°å’Œç±»ï¼Œä½¿è¿”å›å€¼å’Œå‡½æ•°ç­¾ååœ¨ IDE ä¸­æ›´åŠ æ˜ç¡®
- åœ¨ PyCharmã€VSCode ä¸­æ™ºèƒ½æç¤ºå‚æ•°ä¸è¿”å›å€¼ï¼Œå‡å°‘ä½çº§é”™è¯¯
- å¯¹æ–°æ‰‹æˆ–å¤§å‹é¡¹ç›®å°¤å…¶å‹å¥½ï¼Œæå‡å›¢é˜Ÿå¼€å‘æ•ˆç‡

#### ç¤ºä¾‹1
![celery-type-1](docs/images/celery-type-1.png)
#### ç¤ºä¾‹2
![celery-type-2](docs/images/celery-type-2.png)
#### ç¤ºä¾‹3
![celery-type-3](docs/images/celery-type-3.png)

> æ›´å¤šç»†èŠ‚è¯·å‚è€ƒ `src.queues` ç›®å½•ä¸­çš„æºä»£ç ï¼Œäº†è§£ä»»åŠ¡æ³¨å†Œã€è°ƒåº¦å™¨å®ç°ä»¥åŠå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œé€»è¾‘ã€‚

---

## Git ç›¸å…³è§„èŒƒ
è§ <span><a href="./docs/GIT-CN.md">Git è§„èŒƒ</a></span>

---

## è®¸å¯è¯
æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯ï¼Œè¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---
